@model StoreManagement.Web.Areas.BasicData.ViewModels.AddInvoiceViewModel
@using StoreManagement.Web.Areas.BasicData.ViewModels
@{
    ViewBag.Title = "Invoice";
    var today = PersianDateTime.Now.ToString(PersianDateTimeFormat.Date);
}


<h2>ثبت فاکتور</h2>

<div id="editable_form">
    <form class="form-horizontal" id="invoiceForm">
        @Html.AntiForgeryToken()

        <hr/>
        <div class="validation-summary-errors text-danger" id="validSummery">
            <ul></ul>
        </div>

        <div class="form-group">
            @Html.LabelFor(model => model.Number, htmlAttributes: new { @class = "control-label col-md-2" })
            <div class="col-md-10">
                @Html.EditorFor(model => model.Number, new { htmlAttributes = new { @class = "form-control" } })
                @Html.ValidationMessageFor(model => model.Number, "", new { @class = "text-danger" })
            </div>
        </div>
        <div class="form-group">
            @Html.LabelFor(model => model.CustomerId, htmlAttributes: new { @class = "control-label col-md-2" })
            <div class="col-md-10">
                <select id="CustomerId" class="form-control" data-val="true"
                        data-val-required="مشتری را انتخاب کنید" name="CustomerId">
                    @foreach (var c in Model.Customers)
            {
                        <option value="@c.Id">  @c.FirstName @c.LastName  </option>
                    }
                </select>
                @Html.ValidationMessageFor(model => model.CustomerId, "", new { @class = "text-danger" })
            </div>
        </div>
        <div class="form-group">
            @Html.LabelFor(model => model.CreatedOnString, htmlAttributes: new { @class = "control-label col-md-2" })
            <div class="col-md-10">
                <input type="text" id="CreatedOnString" name="CreatedOnString" onclick="PersianDatePicker.Show(CreatedOnString,'@today' );"  data-val="true" data-val-required="تاریخ را وارد کنید"/>
                <img src="https://sonomalibrary.org/sites/default/files/calendar.png" height="35px" width="35px" onclick="PersianDatePicker.Show(CreatedOnString,'@today' );"> 
                     @Html.ValidationMessageFor(model => model.CreatedOnString, "", new { @class = "text-danger" })
            </div>
        </div>
        <hr />
        <div id="jsGrid">

        </div>
        <div class="form-group">
            @Html.LabelFor(model => model.Price, htmlAttributes: new { @class = "control-label col-md-2" })
            <div class="col-md-10">
                @Html.EditorFor(model => model.Price, new { htmlAttributes = new { @class = "form-control", id = "text" } })
            </div>
        </div>
        <br />
        <div class="form-group">
            <div class="col-md-offset-2 col-md-10">
                <button type="button" id="saveButton" onclick="save_js();" class="btn btn-success">  ذخیره  </button>
                <button type="button" id="saveAndNewButton" onclick="SaveAndNew();" class="btn btn-success">  ذخیره و جدید  </button>

            </div>
        </div>
    </form>
</div>

<div>
    @Html.ActionLink("بازگشت به لیست فاکتورها", "List")
</div>

@section css{
    <link type="text/css" rel="stylesheet" href="~/Content/jsgrid.min.css" />
    <link type="text/css" rel="stylesheet" href="~/Content/jsgrid-theme.min.css" />
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.0/themes/base/jquery-ui.css">
    <link type="text/css" href="~/Content/PersianDatePicker.min.css" rel="stylesheet" />
}

@section Scripts {

    @Scripts.Render("~/bundles/jqueryval")

    <script type="text/javascript" src="~/Scripts/PersianDatePicker.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.0/jquery-ui.js"></script>

    <!--   the above is for page edit warning  -->

    <script type="text/javascript" src="~/Scripts/jsgrid.min.js"></script>
    <script type="text/javascript">
        var products = [];
        products.push({Id: 0, Name: "", Price: 0})
        @foreach (var p in Model.Products)
        {
            @:products.push({Id: @p.Id, Name: "@p.Name", Price: @p.Price});
                                                                                                                                                        }
        var Items = [];
        function FindProduct(productId){
            var prod = products.find(function(p)
            {
                return p.Id === productId;
            });
            return prod;
        }

        function AddItem(product,price,quantity){
            var prod = FindProduct(product);
            Items.push({
                "ProductId": product,
                "priceAll": price,
                "Quantity": quantity,
                "Price": prod.Price
            });
        }

        function UpdateTotalPrice(){
            var sum =0;
            for(var i=0; i<Items.length; i++){
                sum = sum + Items[i].priceAll;
                $('#text').val(sum.toString());
            }
        }


        $("#jsGrid").jsGrid({
            width: "100%",
            height: "400px",

            editing: true,
            sorting: true,
            paging: true,

            noDataContent: function(){
                if($("#jsGrid").jsGrid("option","inserting") == false)
                    $("#jsGrid").jsGrid("option","inserting",true);
            },

            controller:
           {
               insertItem: function(item){
                   var prod = FindProduct(item.ProductId);
                   item.Price = prod.Price;
                   item.priceAll = item.Price * item.Quantity;
                   return item;
               }
           },
            onItemUpdating: function(args){
                if(args.item.Price != args.previousItem.Price ||
                    args.item.Quantity != args.previousItem.Quantity)
                {
                    args.item.priceAll = args.item.Price * args.item.Quantity;
                }
                if(args.item.priceAll != args.previousItem.priceAll){
                    args.item.Price = args.item.priceAll / args.item.Quantity;
                }
                if(args.item.ProductId != args.previousItem.ProductId){
                    var prod = FindProduct(args.item.ProductId);
                    args.item.Price = prod.Price;
                    args.item.priceAll = args.item.Price * args.item.Quantity;
                }

            },

            onItemInserted: function(args){
                UpdateTotalPrice();
            },

            onItemUpdated: function(args){
                UpdateTotalPrice();
            },

            onItemDeleted: function(args){
                if(Items.length != 0)
                    UpdateTotalPrice();
                else
                    $("#text").val("0");
            },

            data: Items,

            invalidMessage:"",
            fields: [
                { name: "ProductId", title: "کالا", type: "select", items: products, valueField: "Id", textField: "Name",
                    validate:{
                        validator: function(value,item,param){
                            if(value != 0){
                                return true;
                            }
                        },
                        message: "کالا را انتخاب کنید."
                    }
                },
                { name: "Quantity", title:"تعداد", type: "number",validate: {
                    validator: "range",
                    message:  "تعداد کالا باید بین 1 تا 100 باشد." ,
                    param: [1,100],
                    width: 60 }},

                { name: "Price",title: "فی", type: "number", width: 100},
                { name: "priceAll", title: "قیمت", type: "number", width: 100 },
                { type: "control" ,modeSwitchButton: false, editButton: false }
            ]
        });


        function save_js(){
            var inputs=[];
            $("#invoiceForm div.form-group :input").each(function(){inputs.push($(this).val())});
            var model = {
                Number: inputs[0],
                CustomerId: inputs[1],
                CreatedOnString: inputs[2],
                Price: inputs[3],
                Items: Items
            };
            $("#validSummery").empty();
            if(Items.length == 0){
                $("<li>کالایی در فاکتور وجود ندارد</li>").appendTo($("#validSummery"));
            }
            if($("#invoiceForm").valid() && Items.length != 0){
                $.ajax({
                    type: 'POST',
                    url: '@Url.Action("Create","Invoice")',
                    data: model,
                    success: function(data){
                        document.location = '@Url.Action("List","Invoice")';
                    },
                    failure: function(){
                        alert("ذخیره نشد");
                    }
                });
            }
            else{

            }
        }
        function SaveAndNew(){
            var inputs=[];
            $("#invoiceForm div.form-group :input").each(function(){inputs.push($(this).val())});
            var model = {
                Number: inputs[0],
                CustomerId: inputs[1],
                CreatedOnString: inputs[2],
                Price: inputs[3],
                Items: Items
            };
            $("#validSummery").empty();
            if(Items.length == 0){
                $("<li>کالایی در فاکتور وجود ندارد</li>").appendTo($("#validSummery"));
            }
            if($("#invoiceForm").valid() && Items.length != 0){
                $.ajax({
                    type: 'POST',
                    url: '@Url.Action("Create","Invoice")',
                    data: model,
                    success: function(data){
                        document.location = '@Url.Action("Create","Invoice")';
                    },
                    failure: function(){
                        alert("ذخیره نشد");
                    }
                });
            }
            else{

            }
        }
    </script>
}